# üöÄ SUPREME PRODUCTION PIPELINE ‚Äî ICS v4.0 ELITE
# RJ Business Solutions | Rick Jefferson
# Logic: Zero-tolerance testing, security scans, and auto-deployment

name: üöÄ Supreme Production Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '22'

jobs:
  # --- STAGE 1: QUALITY ASSURANCE ---
  quality-gate:
    name: üßπ Static Analysis & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: pip install ruff mypy
      - name: Run Ruff Lint
        run: ruff check .
      - name: Run MyPy Type Check
        run: mypy . --ignore-missing-imports

  # --- STAGE 2: UNIT & INTEGRATION TESTING ---
  test-suite:
    name: üß™ Unit & Integration Tests
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install requirements
        run: pip install -r requirements.txt
      - name: Run Pytest with Coverage
        run: |
          pytest --cov=./ --cov-report=xml tests/unit
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  # --- STAGE 3: SECURITY AUDIT ---
  security-audit:
    name: üõ°Ô∏è Security Scan (OWASP)
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: Run Bandit for Security Issues
        run: |
          pip install bandit
          bandit -r . -x ./venv

  # --- STAGE 4: BUILD & DEPLOY ---
  build-and-push:
    name: üèóÔ∏è Docker Build & Push
    needs: [test-suite, security-audit]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push Supreme Image
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: rjbizsolution23/ics-elite:latest,rjbizsolution23/ics-elite:${{ github.sha }}

  deploy-cloudflare:
    name: ‚òÅÔ∏è Cloudflare Pages Deploy
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy Landing Page
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy cloudflare --project-name=infinite-context-system --branch=main
